_.Module.define({path:"encourage-props/widget/util",sub:{_propCategoryMap:{101:"\u53d1\u8d34\u6c14\u6ce1",102:"",103:"\u4e2a\u6027\u6c34\u5370",104:"\u70ab\u5f69\u5b57\u4f53",105:"",106:"",107:"\u9b54\u6cd5\u5f39",108:"\u8865\u7b7e\u795e\u5668",109:"\u52a8\u6001\u5934\u50cf",110:"\u5934\u50cf\u8fb9\u6846",111:"",112:"\u4e2a\u6027\u94ed\u724c",113:"\u540d\u7247\u80cc\u666f",114:"\u94ed\u724c\u91cd\u94f8\u5361",115:"",116:"\u8d34\u6761\u5361",117:"\u633d\u5c0a\u5361"},_freeUseMap:{1070001:12,1070002:12,1080001:8},_badgeMap:{1:"\u8d34\u5427\u4f1a\u5458",2:"\u8d34\u5427\u8d85\u7ea7\u4f1a\u5458"},initial:function(e){this.opts=e||{}},badgeNameMap:function(e){var a=parseInt(e);return a>105e4&&(a-=105e4),this._badgeMap[a]},getFreeUseCount:function(e){return this._freeUseMap[e]},getMaxLevel:function(e){var a=0,t=+new Date,n=e||this.opts.userProp||{};if(!n||!n.level)return 0;var r=n.level;return 1e3*r.end_time>t&&parseInt(r.props_id,10)>a&&(a=parseInt(r.props_id,10)),a},convertNumber:function(e){return e>99999999?Math.round(e/1e8,2)+"\u4ebf":e>99999?Math.round(e/1e4,2)+"\u4e07":e},formatDate:function(e){function a(e){return e>9?e:"0"+e.toString()}var t=new Date(1e3*e);return t.getFullYear()+"\u5e74"+(t.getMonth()+1)+"\u6708"+t.getDate()+"\u65e5 "+a(t.getHours())+":"+a(t.getMinutes())},hasOwnProp:function(e,a){return PageData.props[e]&&PageData.props[e][a]&&1e3*PageData.props[e][a].end_time>Env.server_time},convertToDay:function(e){return Math.ceil(e/86400)+"\u5929"},getCategoryName:function(e){return this._propCategoryMap[e]},getFreeInfo:function(e){var a=this,t='<div class="free_info">';return"1080002"==e.props_id?(t+='<span  title="'+a.badgeNameMap(2)+'" >',t+='<a class="j_tbmall_join_vip_btn strong_txt level2"><span class="icon-crown-super-vip"></span>\u4e00\u6b21\u5145\u503c12\u4e2a\u6708\uff0c</a>\u9001\u4e09\u5f20</span>'):1==e.props_type&&a.getFreeUseCount(e.props_id)?(t+='<span  title="'+a.badgeNameMap(2)+'" >',t+='<a class="j_tbmall_join_vip_btn strong_txt level2"><span class="icon-crown-super-vip"></span>\u5f00\u901a\u8d85\u7ea7\u4f1a\u5458</a>\u514d\u8d39\u4f7f\u7528',t+='<span class="free_use_count">'+a.getFreeUseCount(e.props_id)+"</span>\u4e2a</span>"):1!=e.props_type&&(t+='<span  title="'+a.badgeNameMap(e.free_user_level)+'" >',t+='<a class="j_tbmall_join_vip_btn strong_txt level'+e.free_user_level+'"><span class="icon-crown-super-vip"></span>\u5f00\u901a'+(2==e.free_user_level?"\u8d85\u7ea7":"")+"\u4f1a\u5458</a>\u514d\u8d39\u4f7f\u7528</span>"),t+="</div>"},hasUsedProp:function(e,a){return PageData.props[e]&&!!PageData.props[e][a]&&!!parseInt(PageData.props[e][a].open_status,10)},hasBadge:function(){return PageData.props.level&&PageData.props.level.prop_id&&1e3*PageData.props.level.end_time>Env.server_time},shouldHaveProp:function(e){return e>0&&this.hasBadge()&&PageData.props.level.prop_id>=e},getBuyInfo:function(e){var a,t,n=this,r="",s=e.props_category,p=e.props_id,o=e.free_user_level,i=n.hasOwnProp(s,p),u=n.hasUsedProp(s,p),_=n.shouldHaveProp(o);return i?"1"===e.is_default_used&&(u?(t="\u53d6\u6d88\u4f7f\u7528",a="j_cancle_use"):(t="\u4f7f\u7528",a="j_use"),r+=['<a href="#" class="ui_btn ui_btn_sub_s '+a+'">',"<span><em>"+t+"</em></span>","</a>"].join("")):(_?(a="j_get_button1",t="\u9886\u53d6"):(a="j_buy_button1",t="\u5151&nbsp;&nbsp;\u6362"),r+=['<a class="ui_btn ui_btn_sub_s '+a+'">',"<span><em>"+t+"</em></span>","</a>"].join("")),r}}});_.Module.define({path:"encourage-props/widget/cont_sign_card",requires:["encourage-props/widget/util","encourage-props/widget/dialog","encourage-member/widget/join_vip_dialog"],sub:{_card_count:0,_tpl:'<div class="header">\u70b9\u51fb\u6211\u5173\u6ce8\u7684\u5427\u4f7f\u7528\u8fde\u7eed\u7b7e\u5230\u5361\uff08<span class="condition">\u6ce8\uff1a\u4f7f\u7528\u6761\u4ef6\u4e3a\u7d2f\u8ba1\u7b7e\u5230\u5929\u6570\u2265100\u5929\uff0c\u4ec5\u4f1a\u5458\u53ef\u4ee5\u4f7f\u7528</span>\uff09\uff1a</div><div id="j_signable_list" class="signable_list"><img class="loading" src="//tb1.bdstatic.com/tb/static-tbmall/img/loading.gif"></div><div class="bottom_info"><div class="my_cont_card">\u6211\u6709<span class="j_card_count orange_txt">0</span>\u5f20<span class="orange_txt">\u8fde\u7eed\u7b7e\u5230\u5361</span></div><p class="">\u8fde\u7eed\u7b7e\u5230\u5361\u5c06\u628a\u9009\u4e2d\u5427\u6240\u6709\u7684\u7b7e\u5230\u5929\u6570\u8fde\u7eed\u5728\u4e00\u8d77\uff01</p> </div> <div class="free_info"><span title="\u8d85\u7ea7\u8d34\u5427\u4f1a\u5458"><a class="j_tbmall_join_vip_btn strong_txt level2"><span class="icon"></span>\u4e00\u6b21\u5145\u503c12\u4e2a\u6708\uff0c</a>\u9001\u4e09\u5f20</span> </div>',initial:function(e){return e||(e={}),this.util=this.requireInstance("encourage-props/widget/util",[e]),this.mdialog=this.requireInstance("encourage-props/widget/dialog"),this.vip=this.requireInstance("encourage-member/widget/join_vip_dialog"),this.pageData=window.PageData,this.pageData.user.is_login?(this.build(),this.loadSignableList(),this.bindEvent(),void 0):(this.requireInstance("tbui/widget/LoginDialog"),void 0)},showMemberOnly:function(){var e=this,t=['<div id="sign_tip_forNoMember" class="sign_tip_forNoMember">',"<p><span>\u8fde\u7eed\u7b7e\u5230\u5361</span>\u662f\u4f1a\u5458\u4e13\u5c5e\u9053\u5177,\u6210\u4e3a\u4f1a\u5458\u5373\u53ef\u4f7f\u7528!</p>",'<a class="ui_btn ui_btn_m j_openMember" href="#"><span><em>\u9a6c\u4e0a\u5f00\u901a</em></span></a>','<p><a class="j_tbmall_join_vip_btn level2_icon" href="#">\u5145\u6ee112\u4e2a\u6708\u8d85\u7ea7\u4f1a\u5458</a>\u9001\u4e09\u5f20</p>',"</div>"].join(""),i=new $.dialog({html:t,title:"\u63d0\u793a",width:430,height:100});$("#sign_tip_forNoMember").delegate(".j_openMember","click",function(t){t.preventDefault(),i.close(),e.vip.getMemberDialog()}),$("#sign_tip_forNoMember").delegate(".j_tbmall_join_vip_btn","click",function(t){t.preventDefault(),i.close(),e.vip.getMemberDialog()})},build:function(){var e=this;this._dialog=new $.dialog({title:"\u4f7f\u7528\u8fde\u7eed\u7b7e\u5230\u5361",html:e._tpl,width:662,holderClassName:"cont_sign_dialog",fixed:!1}),this._listdom=this._dialog.element.find("#j_signable_list")},loadSignableList:function(){var e=this,t="";$.tb.get("/tbmall/get/getContSignableList",function(i){if(i&&0==i.no){var a=i.data.list;if(a.length){for(var n=0,s=a.length;s>n;n++)t+='<a href="/f?kw='+encodeURIComponent(a[n].forum_name)+'&ie=utf-8" target="_blank" data-fid="'+a[n].forum_id+'" class="signable_ba j_signable_ba">'+$.tb.subByte(a[n].forum_name,11)+'<span class="forum_level lv'+a[n].level_id+'"></span></a> ';e._listdom.html(""),_.Module.use("tbui/widget/ScrollPanel",[{content:t,container:e._listdom,height:210}])}else t='<div class="no_signable_tip gray_txt">\u6ca1\u6709\u68c0\u6d4b\u5230\u4f60\u6709\u7d2f\u8ba1\u7b7e\u5230\u2265100\u5929\uff0c\u6216\u8005\u65ad\u7b7e\u7684\u5427\uff0c\u8bf7\u6838\u5b9e\u540e\u5237\u65b0\u9875\u9762\u3002</div>',e._dialog.element.find("#j_signable_list").height(280).html(t);e._card_count=i.data.card_count,e._dialog.element.find(".j_card_count").text(i.data.card_count)}else t="\u54ce\u5440\uff0c\u670d\u52a1\u5668\u62bd\u98ce\u4e86\uff0c\u8bf7\u5173\u95ed\u7a97\u53e3\u91cd\u65b0\u52a0\u8f7d",e._dialog.element.find("#j_signable_list").html(t)})},bindEvent:function(){var e=this;this._dialog.element.on("click",".j_signable_ba",function(t){return e.util.getMaxLevel()?($(this).hasClass("signed")||(t.preventDefault(),e.showBubble($(this))),void 0):(t.preventDefault(),e._dialog.close(),e.showMemberOnly(),void 0)}),this._dialog.bind("onclose",function(){e._bubble&&e._bubble.closeBubble()})},showBubble:function(e){var t=this;if(!t._isAjaxing){var i=e.data("fid"),a=e.offset(),n={arrow_dir:"up",bubble_css:{top:a.top+37,left:a.left-39,width:172,height:69,zIndex:6e4},arrow_pos:{left:87},wrap:$("body"),closeBtn:!0},s='<div class="card_bubble_content"><span>\u6ca1\u6709<span class="blue_txt">\u8fde\u7eed\u7b7e\u5230\u5361</span></span><div><a href="/tbmall/propslist?category=108" target="_blank" class="ui_btn ui_btn_sub_s j_buy_card"><span><em>\u7acb\u5373\u8d2d\u4e70</em></span></a> </div></div>',l='<div class="card_bubble_content"><span>\u9700\u8981\u6d88\u8017<span class="blue_txt">1\u5f20\u8fde\u7eed\u7b7e\u5230\u5361</span></span><div><a class="ui_btn ui_btn_sub_s j_use_card"><span><em>\u786e \u5b9a</em></span></a> </div></div>',o='<div class="card_bubble_content"><span class="blue_txt">\u5df2\u7ecf\u6210\u529f\u4f7f\u7528\u8fde\u7eed\u7b7e\u5230\u5361,\u70b9\u51fb\u5427\u540d\u67e5\u770b</span></div>',_='<div class="card_bubble_content"><span>\u8fde\u7eed\u7b7e\u5230\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5~</span></div>';t._bubble&&t._bubble.closeBubble(),n.content=t._card_count<1?s:l,t._bubble=this.requireInstance("tbui/widget/bubble_tip",[n]),t._bubble.j_bubble.one("click",".j_buy_card",function(){t._bubble.closeBubble()}).one("click",".j_use_card",function(a){a.preventDefault(),t._isAjaxing=!0,t._bubble.setContent('<div class="card_bubble_content"><img src="//tb1.bdstatic.com/tb/static-tbmall/img/loading.gif">\u6b63\u5728\u8fde\u7eed\u7b7e\u5230...</div>'),$.tb.post("/tbmall/post/useContSignCard",{forum_id:i,tbs:PageData.tbs},function(i){t._isAjaxing=!1,i&&0==i.no?(t._card_count--,t._card_count=Math.max(0,t._card_count),t._dialog.element.find(".j_card_count").text(t._card_count),t._bubble.setContent(o),e.addClass("signed")):t._bubble.setContent(_)})}),t._bubble.showBubble()}}}});_.Module.define({path:"encourage-props/widget/net_proxy",requires:["encourage-payment/widget/tbean_safe_ajax"],sub:{_buyPropUrl:"/tbmall/post/buyprops",_mBuyPropUrl:"/tbmall/post/mbuyprops",_usePropUrl:"/tbmall/post/openProps",_mUsePropUrl:"/tbmall/post/mopenProps",_cancelPropUrl:"/tbmall/post/closeProps",initial:function(){},buyProp:function(t,o){var r=this;t.tbs=PageData.tbs;var s=this.requireInstance("encourage-payment/widget/tbean_safe_ajax");s.post(r._buyPropUrl,t,o)},mBuyProp:function(t,o){var r=this;t.tbs=PageData.tbs,$.tb.post(r._mBuyPropUrl,t,o)},useProp:function(t,o){var r=this;$.tb.post(r._usePropUrl,{props_id:t,tbs:PageData.tbs},o)},mUseProp:function(t,o){var r=this;t.tbs=PageData.tbs,$.tb.post(r._mUsePropUrl,t,o)},cancelProp:function(t,o){var r=this;$.tb.post(r._cancelPropUrl,{props_id:t,tbs:PageData.tbs},o)}}});_.Module.define({path:"encourage-props/widget/use_controller",requires:["encourage-props/widget/NetProxy","encourage-props/widget/Dialog","encourage-props/widget/util"],sub:{buy_number:0,initial:function(){this.netProxy=this.use("encourage-props/widget/NetProxy"),this.dialog=this.use("encourage-props/widget/Dialog"),this.util=this.use("encourage-props/widget/util")},doUse:function(e,a){var i;$.isNumeric(e)?i=e:(this.wrap=e,i=a.props_id);var o=this;$.stats.track(i,"\u8d34\u5427\u5546\u57ce",PageData.page,"\u70b9\u51fb\u4f7f\u7528"),o.netProxy.useProp(i,function(e){var a="";if(0==e.no)a="\u4f7f\u7528\u6210\u529f\uff01";else switch(e.no){case 2270005:a="\u54ce\u5440\uff0cT\u8c46\u4e0d\u8db3";break;case 2270001:a="\u5df2\u7ecf\u4e70\u8fc7\u5566";break;case 2270004:a="\u60a8\u5df2\u7ecf\u62e5\u6709\u4e86\u66f4\u9ad8\u7ea7\u7684\u52cb\u7ae0\uff0c\u65e0\u9700\u8d2d\u4e70\u672c\u52cb\u7ae0\uff01";break;case 2270006:a="\u672c\u9053\u5177\u4e0d\u53ef\u91cd\u590d\u8d2d\u4e70";break;default:a="\u54ce\u5440\uff0c\u670d\u52a1\u5668\u62bd\u98ce\u4e86\u3002\u8bf7\u7a0d\u7b49\u4e00\u4f1a~~"}o.wrap&&o.wrap.data("clicked",!1),o.dialog.info('<div class="tip">'+a+"</div>"),0==e.no&&o.dialog.bind("onInfoClose",function(){$.tb.location.reload()})})},cancelUse:function(e,a){var i;$.isNumeric(e)?i=e:(this.wrap=e,i=a.props_id);var o=this;$.stats.track(i,"\u8d34\u5427\u5546\u57ce",PageData.page,"\u53d6\u6d88\u4f7f\u7528"),o.netProxy.cancelProp(i,function(e){var a="";if(0==e.no)a="\u53d6\u6d88\u4f7f\u7528\u6210\u529f\uff01";else switch(e.no){case 2270005:a="\u54ce\u5440\uff0cT\u8c46\u4e0d\u8db3";break;case 2270001:a="\u5df2\u7ecf\u4e70\u8fc7\u5566";break;case 2270004:a="\u60a8\u5df2\u7ecf\u62e5\u6709\u4e86\u66f4\u9ad8\u7ea7\u7684\u52cb\u7ae0\uff0c\u65e0\u9700\u8d2d\u4e70\u672c\u52cb\u7ae0\uff01";break;case 2270006:a="\u672c\u9053\u5177\u4e0d\u53ef\u91cd\u590d\u8d2d\u4e70";break;default:a="\u54ce\u5440\uff0c\u670d\u52a1\u5668\u62bd\u98ce\u4e86\u3002\u8bf7\u7a0d\u7b49\u4e00\u4f1a~~"}o.wrap.data("clicked",!1),o.dialog.info('<div class="tip">'+a+"</div>"),0==e.no&&o.dialog.bind("onInfoClose",function(){$.tb.location.reload()})})}}});_.Module.define({path:"encourage-props/widget/BuyController",requires:[],sub:{buy_number:0,set_pass_tpl:'<div class="buy_tpl_set_pass"><p><a class="buy_tpl_setpass_link" href="/tbmall/pass/set" target="_blank">\u7acb\u5373\u8bbe\u7f6e\u652f\u4ed8\u5bc6\u7801</a>\uff0c\u964d\u4f4eT\u8c46\u88ab\u76d7\u98ce\u9669!</p></div>',buy_tpl0:'<div class="buy_tpl clearfix"> <div class="buy_tpl_left"><div class="prop_img"><img src="#{imgsrc}"></div><div class="title">#{title}</div><div class="price">#{price_unit}</div></div> <div class="buy_tpl_right"><div class="price_tip">\u60a8\u9700\u8981<span class="strong_txt">#{price}</span>T\u8c46\u5151\u6362\u9053\u5177</div> #{TbeanCharge}<a class="ui_btn ui_btn_sub_m j_confirm_buy j_buy_button"><span><em>\u786e\u8ba4\u5151\u6362</em></span></a><div class="buy_tpl_set_pass"><p><a class="buy_tpl_setpass_link" href="/tbmall/pass/set" target="_blank">\u7acb\u5373\u8bbe\u7f6e\u652f\u4ed8\u5bc6\u7801</a>\uff0c\u964d\u4f4eT\u8c46\u88ab\u76d7\u98ce\u9669!</p></div></div></div> ',buy_tpl1:['<div class="buy_tpl buy_count_tpl clearfix">',' <div class="buy_tpl_left"><div class="prop_img"><img src="#{imgsrc}"></div><div class="title">#{title}</div><div class="price">#{price_unit}</div>','</div> <div class="buy_tpl_right">','<p class="count_tip">\u60a8\u8981\u5151\u6362\u7684\u6570\u91cf</p>','<div class="count_wrap clearfix"><span class="count_number">\u6570\u91cf\uff1a</span>','<span class="counter"><button class="j_minus minus"></button><input type="text" class="j_count" value="1"/><button class="j_plus plus"></button></span><span>\u4e2a</span>',"</div>",'<div class="count_tip count_sub_tip">\u9700\u8981T\u8c46\uff1a<span class="t_dou_needed strong_txt">#{price}</span>\u4e2a  \u60a8\u76ee\u524dT\u8c46\uff1a<span class="cur_t_dou">#{cur_t_dou}</span>\u4e2a</div>',"#{TbeanCharge}",'<div class="buy_and_tip"><a class="btn-sub btn-middle ui_btn ui_btn_sub_m j_confirm_buy j_buy_button"><span><em>\u786e\u8ba4\u5151\u6362</em></span></a><span class="error_tip"></span></div>','<div class="buy_tpl_set_pass"><p><a class="buy_tpl_setpass_link" href="/tbmall/pass/set" target="_blank">\u7acb\u5373\u8bbe\u7f6e\u652f\u4ed8\u5bc6\u7801</a>\uff0c\u964d\u4f4eT\u8c46\u88ab\u76d7\u98ce\u9669!</p></div>'," </div></div> "].join(""),initial:function(e,t){this.data=t;$.stats.track(this.data.props_id,"\u8d34\u5427\u5546\u57ce",PageData.page,"\u70b9\u51fb\u5151\u6362"),this.netProxy=this.requireInstance("encourage-props/widget/NetProxy"),this.dialog=this.requireInstance("encourage-props/widget/Dialog"),this.util=this.requireInstance("encourage-props/widget/util"),this.useController=this.requireInstance("encourage-props/widget/UseController"),this.isAvailable()&&this.doBuy(e),$(e).data("clicked",!1)},isAvailable:function(){var e=this.data,t=this,a=EncourageData.userScore,s=null!=a.scores_money?parseInt(a.scores_money):0,n=null!=a.scores_other?parseInt(a.scores_other):0,i=s+n,r=Math.min(parseInt(a.scores_fetch),parseInt(t.data.fetch_scores_limit||0)),c=parseInt(i+r);return PageData.user.is_login?PageData.user.no_un?(TbCom.process("User","BuildUnameFrame","\u586b\u5199\u7528\u6237\u540d","\u6709\u7528\u6237\u540d\u624d\u53ef\u4ee5\u5728T\u8c46\u5546\u57ce\u8d2d\u7269\u5662~"),!1):c<parseInt(e.scores)?(t.dialog.dialog("<p class='dialog_content'>T\u8c46\u4f59\u989d\u4e0d\u8db3\uff0c\u5151\u6362\u9053\u5177\u9700\u8981<span class='charge_bean_interaction_orange_tip' >"+e.scores+"</span>T\u8c46</p><div class='charge_bean_interaction_dialog_btn_wrap'><a class='charge_bean_interaction_charge_btns charge_bean_interaction_j_charge_btn' id='j_tcharge_dialog_tbmall'>\u83b7\u53d6T\u8c46</a><a class='charge_bean_interaction_charge_btns charge_bean_interaction_j_close_dialog'>\u53d6\u6d88</a></div>"),$("#j_tcharge_dialog_tbmall").on("click",function(){var a={consumption_path:"12",desc:"\u5151\u6362\u9053\u5177",current_need_tdou:parseInt(e.scores,10)-i,is_direct_cashier:!0,is_iframe:!0};t.requireInstance("encourage-payment/widget/tcharge_dialog",a)}),!1):!0:(TbCom.process("User","buildLoginFrame"),!1)},bindCountEvent:function(e){var t=this,a=t._buyDialog,s=a.element.find(".j_count");a.element.on("click",".j_minus",function(){var a=parseInt(s.val())||1;a=Math.max(1,a-1),a=Math.min(999,a),s.val(a),$(".t_dou_needed").text(e*a);var n=Math.min(EncourageData.userScore.scores_fetch,(t.data.fetch_scores_limit||0)*a);$(".Tbean_num").text(n),t.checkCountError()}).on("click",".j_plus",function(){var a=parseInt(s.val())||1;a++,a=Math.min(999,a),s.val(a),$(".t_dou_needed").text(e*a);var n=Math.min(EncourageData.userScore.scores_fetch,(t.data.fetch_scores_limit||0)*a);$(".Tbean_num").text(n),t.checkCountError()}),s.on("input propertychange",function(){var a=/^[1-9]\d*$/,n=s.val();(n&&!a.test(n)||a.test(n)&&n>999)&&(n=n.replace(/\D/g,"").replace(/^0(\d*)$/,"$1"),n=Math.min(999,n),s.val(n)),$(".t_dou_needed").text(e*n),t.checkCountError()}).on("blur",function(){var a=s.val()&&parseInt(s.val())>0&&parseInt(s.val())||1;a=Math.min(999,a),s.val(a),$(".t_dou_needed").text(e*a),t.checkCountError()}),a.element.on("click",".j-get-tdou",function(){var e={consumption_path:120};a.close(),t.requireInstance("encourage-payment/widget/tcharge_dialog",e)})},checkCountError:function(){var e=this,t=e._buyDialog,a=t.element.find(".t_dou_needed"),s=t.element.find(".error_tip"),n=t.element.find(".j_count"),i=n.val(),r=t.element.find(".j_buy_button"),c=EncourageData.userScore,o=parseInt(c.scores_money+c.scores_other),_=Math.min(parseInt(c.scores_fetch),parseInt(e.data.fetch_scores_limit||0)),l=parseInt(o+_);return 999==i?(s.text("\u5355\u6b21\u9650\u5151999\u4e2a"),s.show()):s.hide(),l<parseInt(a.text())?(s.text("T\u8c46\u4f59\u989d\u4e0d\u8db3").addClass("j-get-tdou"),s.show(),r.addClass("ui_btn_disable ui_btn_m_disable").removeClass("ui_btn ui_btn_sub_m j_confirm_buy"),!1):(s.hide().removeClass("j-get-tdou"),r.addClass("ui_btn ui_btn_sub_m j_confirm_buy").removeClass("ui_btn_disable ui_btn_m_disable"),!0)},doBuy:function(){var e,t=this.data,a=this,s="",n="",i=parseInt(t.fetch_scores_limit,10)||0,r=EncourageData.userScore.scores_fetch;n=0===i||0===r?"":['<div class="TbeanCharge_container">','<input id="j_charge_checked" type="checkbox" name="TbeanCharge_check" />','\u53ef\u4f7f\u7528<span class="icon_Tbean_num"></span><span class="Tbean_num">',Math.min(r,i),"</span>\u8c46\u7968\u62b5\u7528T\u8c46","</div>"].join(""),"0"==t.props_type?(EncourageData.userScore.setpass&&(a.buy_tpl0=a.buy_tpl0.replace("buy_tpl_set_pass","buy_tpl_set_none")),s=$.tb.format(a.buy_tpl0,{price:t.scores,price_unit:t.scores+"T\u8c46/"+a.util.convertToDay(t.time_interval),title:t.name,imgsrc:t.imgsrc,level:t.free_user_level,TbeanCharge:n}),e=480):"1"==t.props_type&&(EncourageData.userScore.setpass&&(a.buy_tpl1=a.buy_tpl1.replace("buy_tpl_set_pass","buy_tpl_set_none")),s=$.tb.format(a.buy_tpl1,{price:t.scores,price_unit:t.scores+"T\u8c46/1\u4e2a",title:t.name,imgsrc:t.imgsrc,cur_t_dou:EncourageData.userScore.scores_total,level:2,TbeanCharge:n}),e=560);var c=220;EncourageData.userScore.setpass&&(c=200),a._buyDialog=new $.dialog({html:s,title:"\u5151\u6362\u9053\u5177",width:e,height:c}),EncourageData.userScore.setpass?a._buyDialog.element.find(".buy_tpl_right").append(a.util.getFreeInfo(t)):a._buyDialog.element.find(".buy_tpl_left").append(a.util.getFreeInfo(t)),"1"==t.props_type&&a.bindCountEvent(t.scores),a._buyDialog.element.one("click",".j_confirm_buy",function(){var e={props_id:t.props_id};if("1"==t.props_type&&!a.checkCountError())return a._buyDialog.element.one("click",".j_confirm_buy",arguments.callee),void 0;"1"==t.props_type&&(e.buy_num=a._buyDialog.element.find(".j_count").val()),i>0&&$("#j_charge_checked").length&&$("#j_charge_checked")[0].checked&&(e.use_fetch_scores=$(".Tbean_num").text()),$.stats.track(t.props_id,"\u8d34\u5427\u5546\u57ce",PageData.page,"\u786e\u5b9a\u5151\u6362");var s=function(n){n&&$.extend(e,n),a.netProxy.buyProp(e,function(n){var i="",r="",c=a.requireInstance("encourage-payment/widget/TbeanSafe",{json:n,sucCallback:s,content:a});if(!c.needCheck()){if(0==n.no){switch(t.props_category){case"107":r='\u5728\u8d34\u5427\u8be6\u60c5\u9875\u70b9\u51fb<img style="vertical-align:middle;" src="/tb/static-tbmall/img/magic_show_icon.png" />\u4f7f\u7528';break;case"108":"1080001"==t.props_id&&(r="\u5728\u7b7e\u5230\u9875\u9762\u4f7f\u7528");break;case"101":r="\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u4f7f\u7528\u4f60\u7684\u53d1\u8d34\u6c14\u6ce1";break;case"104":r="\u5728\u53d1\u8d34\u6846\u4e2d\u4f7f\u7528";break;case"105":r="\u60a8\u5df2\u6210\u529f\u62e5\u6709\u8be5\u52cb\u7ae0\u5bf9\u5e94\u7684\u9053\u5177\u7279\u6743\uff0c\u5feb\u53bb\u4f7f\u7528\u5427\uff01";break;case"109":case"110":r="\u5728\u5f53\u524d\u9875\u9762\u4f7f\u7528";break;case"113":r="\u5728\u4e2a\u4eba\u4e2d\u5fc3\u4f7f\u7528"}i="1"==t.props_type?"\u5151\u6362"+e.buy_num+"\u4e2a<span class='orange_txt'>"+n.data.title+"</span>\u6210\u529f\uff01<br>"+r:"\u5151\u6362<span class='orange_txt'>"+n.data.title+"</span>\u6210\u529f\uff01\u6709\u6548\u671f\u81f3<span class='orange_txt'>"+a.util.formatDate(n.data.end_time)+"</span><br>"+r}else switch(n.no){case 2270005:i="\u54ce\u5440\uff0cT\u8c46\u4e0d\u8db3";break;case 2270001:i="\u9886\u53d6\u6210\u529f`(*\u2229_\u2229*)\u2032";break;case 2270004:i="\u60a8\u5df2\u7ecf\u62e5\u6709\u4e86\u66f4\u9ad8\u7ea7\u7684\u52cb\u7ae0\uff0c\u65e0\u9700\u5151\u6362\u672c\u52cb\u7ae0\uff01";break;case 2270006:i="\u672c\u9053\u5177\u4e0d\u53ef\u91cd\u590d\u5151\u6362";break;case 360007:case 2150040:var o=a.requireInstance("encourage-props/widget/captcha_payment",{data:n});return o.showCaptcha(s),void 0;case 2270018:case 1990005:case 2190005:n.data=n.data||{};var _=a.requireInstance("encourage-props/widget/paykey_dialog",{showType:2,errType:n.no,errTime:n.data.wrongtime});return _.showDialog(s,function(){},a),void 0;default:i="\u54ce\u5440\uff0c\u670d\u52a1\u5668\u62bd\u98ce\u4e86\u3002\u8bf7\u7a0d\u7b49\u4e00\u4f1a~~"}0==n.no&&($.inArray(t.props_category,["109","110","114"])>-1||"1080002"==t.props_id)?a.dialog.confirm('<div class="tip">'+i+"</div>",{button:[{txt:"\u7acb\u5373\u4f7f\u7528",extraclass:"j_nameplate_recast1",callback:function(){a.dialog.close(),"1080002"==t.props_id?a.requireInstance("encourage-props/widget/ContSignCard"):"1140001"==t.props_id?$(".j_nameplate_recast").trigger("click"):a.useController.doUse(parseInt(n.data.props_id))}},{txt:"\u7a0d\u540e\u4f7f\u7528",callback:function(){a.dialog.close(),$.tb.location.reload()}}]}):0==n.no&&$.inArray(t.props_category,["101"])>-1?(a.dialog.info('<div class="tip tip_center">'+i+'</div><div class="tip_bubble_intro"></div><div class="tip_operation"><input type="checkbox" class="tip_check_box"/>\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u6c14\u6ce1</div>',{title:"\u8d2d\u4e70\u6210\u529f",width:475,height:365,button:"\u6211\u77e5\u9053\u4e86"}),a.dialog.bind("onInfoClose",function(){$(".tip_operation .tip_check_box").tbattr("checked")?$.ajax({url:"/tbmall/submit/setBub",type:"post",dataType:"json",data:{props_id:t.props_id,tbs:PageData.tbs||PageData.user.tbs},success:function(){$.tb.location.reload()},error:function(){$.tb.location.reload()}}):$.tb.location.reload()})):(a.dialog.info('<div class="tip">'+i+"</div>"),0==n.no&&a.dialog.bind("onInfoClose",function(){$.tb.location.reload()}))}})};a._buyDialog.close(),s()})}}});_.Module.define({path:"encourage-props/widget/tieba_sign_card",requires:["encourage-props/widget/BuyController"],sub:{initial:function(t){this.opts=t,this.superboy=this.opts.superboy||"";var e=localStorage.getItem("tieba_sign_card")||"",a=!1,s=0;if(e){var i=new Date(+e.split("|")[0]||0).getDate(),r=(new Date).getDate();s=e.split("|")[1]||0,2>s&&r!==i&&(a=!0)}else a=!0,s=0;"signcard"===this.superboy&&a&&(this.showDialog(),localStorage.setItem("tieba_sign_card",+new Date+"|"+ ++s))},showDialog:function(){$.stats.track("sign_card0628","p10029","frs","view"),$.stats.track("sign_card0628","p10030","frs","view");var t=this,e='<div class="tieba-sign-card-container">     <a href="javascript:;" class="tieba-sign-card-link"></a> </div>',a=_.template(e)({tdouNum:window.EncourageData.userScore.scores_total}),s=new $.dialog({html:a,title:"",holderClassName:"tieba-sign-card",height:400,width:500});s.element.on("click",".tieba-sign-card-link",function(e){s.close(),t.signCard($(e.target)),$.stats.track("sign_card0628","p10033","frs","click"),$.stats.track("sign_card0628","p10034","frs","click")}),s.onclose(function(){$.stats.track("sign_card0628","p10031","frs","click"),$.stats.track("sign_card0628","p10032","frs","click")})},signCard:function(t){var e={};e.props_id="1080001",e.props_category="108",e.props_type="1",e.scores="2669",e.name="\u8865\u7b7e\u5361",e.imgsrc="https://imgsa.baidu.com/forum/pic/item/b7aa3ac79f3df8dcd93e4b2acf11728b461028eb.jpg",e.free_user_level="0",e.time_interval="0",e.fetch_scores_limit="2669",e.is_default_usedd="0";window.EncourageData.userScore.scores_total;this.requireInstance("encourage-props/widget/BuyController",[t,e])}}});